import os

from flask import send_file, request, render_template, render_template_string, redirect
from werkzeug.utils import secure_filename
from magic import Magic

from app.api import api
from app.common import auth

@api.route('/', methods=["GET"])
def api_():
    return "Exploit Town API v1"

# VULN: LFI via image GET parameter
@api.route('/image', methods=['GET'])
def get_file():
    if 'file' in request.args:
        image_file = request.args.get('file')
        image_path = f"/flaskapp/app/image/{image_file}"
        if os.path.isfile(image_path):
            mime = Magic(mime=True)
            mime_type = mime.from_file(image_path)
            return send_file(image_path, mimetype=mime_type)
        else:
            return "Please select an image file that exists"
    else:
        return "Please set file to get an image file"

# VULN arbitrary file uploads
@api.route('/contact', methods=['POST', 'GET'])
def contact():
    from app import app
    if request.method == 'POST':
        print(request.form.get('name'))
        print(request.form.get('email'))
        print(request.form.get('message'))
        if 'formFile' in request.files:
            file = request.files['formFile']
            filename = secure_filename(file.filename)
            if not filename == '':
                file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))
        return render_template('contact/index.html', title='Contact Us', shout='Thank you for your request')
    else:
        return redirect('/contact', code=302)

# VULN SSTI from file
@api.route('/contact/new-files', methods=['GET'])
@auth.login_required
def heartbeat():
    from app import app
    file_list_template = "<div>"
    files = os.listdir(app.config['UPLOAD_FOLDER'])
    for file in files:
        file_list_template += f"<h1>{file}</h1>"
        with open(os.path.join(app.config['UPLOAD_FOLDER'], file), 'r') as open_file:
            first_line = open_file.readline().strip()
            file_list_template += f"<p>{first_line}</p>"
    file_list_template += "</div>"
    return render_template_string(file_list_template)